---
title: "L2C Smartphone App Paper - Descriptive Table for the Use App question"
date: "2021-08-03 <br> Updated: `r Sys.Date()`"
---

# Instructions

Make any data updates you need to make in data_01_import_clean.Rmd. After that file has saved a new version of "/Volumes/sph_research/Link2Care/Statistical Projects/Montgomery - Smartphone/v1_clean.rds", you should just be able to click Run > Run All Chunks Below. This will create an updated Word document in the root directory called, "Smartphone Table Updates.docx".


# ‚≠êÔ∏èOverview

In this file we create a descriptive table exploring the relationships between using a smartphone app to manage health-related uses and each of the following: sociodemographic background, lifetime homelessness, lifetime incarceration, physical and mental health, and access to a mobile phone and data plan.

The two main outcomes of interest are:

Do you believe that a smartphone app can help you to change your actions or behavior? (v1_app_change)
0	=	No
1	=	Yes
7	=	Don't Know
8	=	Refuse to Answer
9	=	Not Applicable


Have you ever used a smartphone app to manage one or more health-related issues? (v1_use_app)
0	=	No
1	=	Yes
7	=	Don't Know
8	=	Refuse to Answer
9	=	Not Applicable


# üì¶Load packages

```{r message=FALSE}
library(dplyr, warn.conflicts = FALSE)
library(readr)
library(freqtables)
library(meantables)
library(purrr)
library(officer)
library(flextable, warn.conflicts = FALSE)
```

```{r}
source("flextable_helpers.R")
```


# üåéConnect to UTH server 

```{bash eval=FALSE}
# Make sure you are connected to the VPN
open 'smb://islgpcifs.uthouston.edu/sph_research/'
```


# üì•Import data 

This data is created and saved in data_01_import_clean.Rmd

```{r}
v1 <- read_rds("/Volumes/sph_research/Link2Care/Statistical Projects/Montgomery - Smartphone/v1_clean.rds")
```

```{r}
dim(v1) # 324  29
```


# üößData management

Drop rows with missing outcome

```{r}
v1_app_change <- v1 %>%
  filter(!is.na(app_change_f))
```

```{r}
v1_use_app <- v1 %>%
  filter(!is.na(use_app_f))
```


# üìàAnalysis

## Outcome distribution

```{r}
n_app_change <- v1_app_change %>% 
  freq_table(app_change_f) %>% 
  pull(n) %>%
  set_names(levels(v1_app_change$app_change_f))

n_app_change
```

```{r}
n_use_app <- v1_use_app %>% 
  freq_table(use_app_f) %>% 
  pull(n) %>%
  set_names(levels(v1_use_app$use_app_f))

n_use_app
```

## Create helper functions

For calculating statistics of interest.

### Categorical statistics

```{r eval=FALSE}
# For testing - slide categories to the left
v1_use_app %>% 
  freq_table(use_app_f, gender_f) %>% 
  freq_format("n (percent_row)", digits = 1) %>% 
  # Change col_var to var to make it easier to bind with cont stats later
  select(row_cat, var = col_var, col_cat, formatted_stats) %>% 
  tidyr::pivot_wider(
    names_from = "row_cat",
    values_from = "formatted_stats"
  ) %>% 
  # Add two spaces in front of categories. This is to reduce the amount of 
  # formatting we have to do in Word. The spaces won't be visible while testing
  # in RStudio, but they will show up in the Word document
  mutate(col_cat = paste0("  ", col_cat)) %>% 
  # Add top row to contain the var name in the col_cat column. This is to 
  # reduce the amount of formatting we have to do in Word. 
  add_row(col_cat = "gender_f", .before = 1) %>% 
  # Now drop var
  select(-var, var = col_cat) %>% 
  # Add blank row below
  add_row(var = "", No = "", Yes = "")
```

```{r}
cat_stats_fn <- function(.data, .outcome, .pred, .digits = 0) {
  .data %>% 
    freq_table({{ .outcome }}, {{ .pred }}) %>% 
    freq_format("n (percent_row)", digits = .digits) %>% 
    # Change col_var to var to make it easier to bind with cont stats later
    select(row_cat, var = col_var, col_cat, formatted_stats) %>% 
    tidyr::pivot_wider(
      names_from = "row_cat",
      values_from = "formatted_stats"
    ) %>% 
    # Add two spaces in front of categories. This is to reduce the amount of 
    # formatting we have to do in Word. The spaces won't be visible while testing
    # in RStudio, but they will show up in the Word document
    mutate(col_cat = paste0("  ", col_cat)) %>%
    # Add top row to contain the var name in the col_cat column. This is to 
    # reduce the amount of formatting we have to do in Word. 
    add_row(col_cat = !!quo_name(enquo(.pred)), .before = 1) %>% 
    # Now drop var
    select(-var, var = col_cat) %>% 
    # Add blank row below
    add_row(var = "", No = "", Yes = "")
}

# For testing  - slide categories to the left
cat_stats_fn(v1_use_app, use_app_f, gender_f, .digits = 1)
# cat_stats_fn(v1_use_app, use_app_f, !!sym("gender_f"))
```

### Continuous statistics

```{r eval=FALSE}
# For testing
v1_use_app %>% 
  filter(!is.na(age)) %>% 
  group_by(use_app_f) %>% 
  summarise(
    var = "age",
    mean = mean(age),
    sd = sd(age),
  ) %>% 
  freq_format("mean (sd)", digits = 1) %>% 
  # Currently, the  first column is named with the group_by variable.
  # We are changing the column name to group_cat to make it easier to row bind
  # later. 
  select(var, group_cat = 1, formatted_stats) %>% 
  tidyr::pivot_wider(
    names_from = "group_cat",
    values_from = "formatted_stats"
  ) %>% 
  # Add blank row below
  add_row(var = "", No = "", Yes = "")
```

```{r}
cont_stats_fn <- function(.data, .outcome, .pred, .digits = 0) {
  .data %>% 
    filter(!is.na({{ .pred }})) %>%
    group_by({{ .outcome }}) %>% 
    summarise(
      var = !!quo_name(enquo(.pred)),
      mean = mean({{ .pred }}),
      sd = sd({{ .pred }}),
    ) %>% 
    freq_format("mean (sd)", digits = .digits) %>% 
    # Change response_var to var to make it easier to bind with cat stats later
    select(var, group_cat = 1, formatted_stats) %>% 
    tidyr::pivot_wider(
      names_from = "group_cat",
      values_from = "formatted_stats"
    ) %>% 
    # Add blank row below
    add_row(var = "", No = "", Yes = "")
}

# For testing
# cont_stats_fn(v1_use_app, use_app_f, age, .digits = 1)
```

## Create data frames of stats for tables

Below, we create descriptive tables by v1_app_change and v1_use_app. 

```{r}
cat_cols <- c(
  "gender_f", "race_eth_4_cat_f", "high_school_grad_f", "employ_5_cat_f", "genhealth_f",
  "ment_health_treat_f", "have_mobile_f", "have_data_plan_f" 
)
```

```{r}
cont_cols <- c("age", "lifetime_homeless", "lifetime_jail")
```

```{r}
# Use this later to reorder the variables in the tables
variable_order <- c(
  "age", "gender_f", "race_eth_4_cat_f", "high_school_grad_f", "employ_5_cat_f", 
  "genhealth_f", "ment_health_treat_f", "lifetime_homeless", "lifetime_jail",
  "have_mobile_f", "have_data_plan_f"
)
```

### app_change stats

Calculate categorical stats for app_change

```{r}
stats_list_app_change <- cat_cols %>%
  set_names(cat_cols) %>% 
  map(~ cat_stats_fn(v1_app_change, app_change_f, !! sym(.x)))
```

**NOTE:** The question about having a data plan has a ton of missing (79%). I dug into this a little more. It's because only 84 out of the 303 participants reported having a cell phone at all. These numbers will obviously change over time as we collect more data, but I imagine the proportions will remain relatively constant.

I could have dropped the row containing the NA responses directly inside of `cat_stats_fn` above, but I like that I was able to see all the missing and investigate it. Having said that, I don't think we need that row to appear in the final table. I'm going to drop it now. We can't just filter it out though, the percentages won't be correct.

```{r}
stats_list_app_change$have_data_plan_f <- v1_app_change %>% 
  # Remove rows for people with no data plan
  filter(!is.na(have_data_plan_f)) %>% 
  # Calculate app_change by have data plan
  cat_stats_fn(app_change_f, have_data_plan_f)
```

Calculate continuous stats for app_change and add them to the stats list

```{r}
stats_list_app_change <- c(
  stats_list_app_change,
  cont_cols %>%
    set_names(cont_cols) %>%
    map(~ cont_stats_fn(v1_app_change, app_change_f, !! sym(.x)))
)
```

#### Bind together categorical and continuous stats

For app_change

```{r}
table_app_change <- map_dfr(
  .x = variable_order,
  .f = ~ bind_rows(stats_list_app_change[[.x]])
)
```

Remove the final blank row. It makes the Word table look cleaner.

```{r}
table_app_change <- slice(table_app_change, -nrow(table_app_change))
```

### use_app stats

Calculate categorical stats for use_app

```{r}
stats_list_use_app <- cat_cols %>%
  set_names(cat_cols) %>% 
  map(~ cat_stats_fn(v1_use_app, use_app_f, !! sym(.x)))
```

**NOTE:** The question about having a data plan has a ton of missing (77%). I dug into this a little more. It's because only 84 out of the 303 participants reported having a cell phone at all. In that light, 71 of those 84 (85%) responded to the question about having a data plan. These numbers will obviously change over time as we collect more data, but I imagine the proportions will remain relatively constant.

I could have dropped the row containing the NA responses directly inside of `cat_stats_fn` above, but I like that I was able to see all the missing and investigate it. Having said that, I don't think we need that row to appear in the final table. I'm going to drop it now. We can't just filter it out though, the percentages won't be correct.

```{r}
stats_list_use_app$have_data_plan_f <- v1_use_app %>% 
  # Remove rows for people with no data plan
  filter(!is.na(have_data_plan_f)) %>% 
  # Calculate use_app by have data plan
  cat_stats_fn(use_app_f, have_data_plan_f)
```

Calculate continuous stats for use_app and add them to the stats list

```{r}
stats_list_use_app <- c(
  stats_list_use_app,
  cont_cols %>%
    set_names(cont_cols) %>%
    map(~ cont_stats_fn(v1_use_app, use_app_f, !! sym(.x)))
)
```

#### Bind together categorical and continuous stats

For use_app

```{r}
table_use_app <- map_dfr(
  .x = variable_order,
  .f = ~ bind_rows(stats_list_use_app[[.x]])
)
```

Remove the final blank row. It makes the Word table look cleaner.

```{r}
table_use_app <- slice(table_use_app, -nrow(table_use_app))
```


# Format tables

To reduce the amount of formatting that needs to be done in word. 

### Make variable names easier for end users to read

```{r}
change_row_names <- function(.data) {
  .data %>% 
    mutate(var = case_when(
      var == "age" ~ "Age, mean (sd)",
      var == "gender_f" ~ "Gender, n (row percent)",
      var == "race_eth_4_cat_f" ~ "Race/Ethnicity, n (row percent)",
      var == "high_school_grad_f" ~ "High school grad or GED, n (row percent)",
      var == "employ_5_cat_f" ~ "Employment status, n (row percent)",
      var == "genhealth_f" ~ "General health, n (row percent)",
      var == "ment_health_treat_f" ~ "Mental health treatment, n (row percent)",
      var == "lifetime_homeless" ~ "Lifetime months homeless, mean (sd)",
      var == "lifetime_jail" ~ "Lifetime years in jail, mean (sd)",
      var == "have_mobile_f" ~ "Have mobile phone, n (row percent)",
      var == "have_data_plan_f" ~ "Have data plan1, n (row percent)",
      TRUE ~ var
    ))
}

# For testing
# change_row_names(table_app_change)
# change_row_names(table_use_app)
```

```{r}
table_app_change <- change_row_names(table_app_change)
table_use_app <- change_row_names(table_use_app)
```


# Create flextables

All the stats are stored in data frames. Next, we will convert those data frames to flextables that we can add to our Word document template.

## app_change

Make column headers

```{r}
table_app_change_ft <- flextable(table_app_change) %>%
  my_ft_theme() %>% 
  # Change column widths. figure out through trial and error
  width(width = c(3.82, 1.34, 1.34)) %>% 
  # Center the final two columns
  align(j = c(2, 3), align = "center", part = "all") %>% 
  # Change header names -- add subgroup Ns to headers
  set_header_labels(
    var = "Characteristic",
    No = paste0("No\n(n=", n_app_change[1], ")"), 
    Yes = paste0("Yes\n(n=", n_app_change[2], ")")
  ) %>% 
  # Bold column headers
  bold(part = "header")
```

## use_app

```{r}
table_use_app_ft <- flextable(table_use_app) %>% 
  my_ft_theme() %>% 
  # Change column widths. figure out through trial and error
  width(width = c(3.82, 1.34, 1.34)) %>% 
  # Center the final two columns
  align(j = c(2, 3), align = "center", part = "all") %>% 
  # Change header names -- add subgroup Ns to headers
  set_header_labels(
    var = "Characteristic",
    No = paste0("No\n(n=", n_use_app[1], ")"), 
    Yes = paste0("Yes\n(n=", n_use_app[2], ")")
  ) %>% 
  # Bold column headers
  bold(part = "header")
```


# üìùLoad Word template for officer

Didn't get time to finish here and below. Ideally, this file will output fully formatted tables and add them to the Word document in the future. For now, I had to copy and paste the tables created above.

```{r}
doc <- read_docx("template_descriptive_analysis.docx") %>%
  body_replace_text_at_bkm("date", as.character(Sys.Date())) %>% 
  body_replace_text_at_bkm("n_app_change", as.character(sum(n_app_change))) %>% 
  body_replace_flextable_at_bkm("table_app_change", table_app_change_ft) %>% 
  body_replace_text_at_bkm("n_use_app", as.character(sum(n_use_app))) %>% 
  body_replace_flextable_at_bkm("table_use_app", table_use_app_ft) 
```


# üìåGenerate Word reports

```{r}
print(
  doc,
  "Smartphone Table Updates.docx"
)
```

